{
  "mcp_version": "2.2",
  "project": "hamclock-next",
  "updated_at": "2026-02-20T16:30:00.000Z",
  "project_context": {
    "title": "HamClock Next \u2014 SDL2 Rewrite",
    "callsign": "K4DRW",
    "repository": "https://github.com/k4drw/hamclock",
    "active_branch": "hamclock-next",
    "legacy_branch": "master",
    "origin": "This project is a full rewrite of Elwood Downey (W7EW)'s HamClock, a feature-rich amateur radio dashboard originally targeting ESP32 and Raspberry Pi via a custom framebuffer/X11 rendering stack. Elwood became a Silent Key on 29 January 2026. This rewrite is dedicated to his memory.",
    "why_rewrite": "The original codebase accumulated ~1.2 million lines across monolithic files (setup.cpp alone is 207K). Incremental patching was unsustainable. The rewrite adopts SDL2, separates concerns into widget classes, uses libcurl/libpredict instead of custom protocol stacks, and targets any SDL2-capable desktop or embedded Linux system.",
    "philosophy": [
      "Each feature is a self-contained Widget class with a consistent interface.",
      "Data fetching is separated from rendering: every widget has a *Provider (services/) and a *Panel (ui/).",
      "Core data structures live in src/core/ as plain data types.",
      "Infrastructure (WebServer, NetworkManager, ConfigManager) is shared.",
      "The layout is fluid/responsive \u2014 not hardcoded to 800x480 like the original.",
      "SDL2 RGBA replaces RGB565. SDL_ttf replaces all custom font/segment renderers.",
      "libpredict v2 replaces Plan 13 for satellite orbit propagation.",
      "libcurl with ETag/Last-Modified caching replaces the custom WiFi/HTTP stack.",
      "JSON config replaces NVRAM and ESP32-specific storage."
    ],
    "tech_stack": {
      "rendering": "SDL2 + SDL_ttf + SDL_image",
      "networking": "libcurl (HTTP), POSIX sockets (Telnet/DX Cluster)",
      "orbital_mechanics": "libpredict v2 (replaces Plan 13 / P13.cpp)",
      "config": "JSON file on disk via ConfigManager",
      "web_api": "Embedded HTTP server (src/network/WebServer), documented in API.md",
      "build": "CMake",
      "language": "C++20"
    }
  },
  "source_layout": {
    "description": "Directory structure of the hamclock-next codebase. Every directory has a clear single responsibility.",
    "tree": {
      "src/": "Root source directory",
      "src/main.cpp": "Entry point. Initializes SDL2, ConfigManager, WebServer, then enters the main event/render loop.",
      "src/core/": "Pure data types, store classes, and shared utilities. No SDL or network calls here.",
      "src/ui/": "All Widget/Panel classes. Each file is a self-contained renderable unit.",
      "src/services/": "Data providers. Each provider fetches and caches data for one domain.",
      "src/network/": "NetworkManager (HTTP/curl) and WebServer (embedded REST API)."
    },
    "naming_conventions": {
      "widget_pair": "Every panel that displays data has a {Name}Panel.cpp/.h (rendering) paired with a {Name}Provider.cpp/.h (data).",
      "data_struct": "Data structures live in src/core/ as {Name}Data.h or {Name}Store.h.",
      "infrastructure": "Singleton-style managers: ConfigManager, NetworkManager, WebServer, UIRegistry.",
      "original_vs_next": "Original used flat .cpp files with global functions. Next uses classes. Example: original updateDXCluster() global \u2192 next DXClusterProvider::update() + DXClusterPanel::render()."
    }
  },
  "widget_scaffolding": {
    "description": "The fastest way to add a new widget or complete a partial one. Follow these steps and fill in the domain-specific logic.",
    "steps": [
      "1. Create src/core/{Name}Data.h \u2014 plain struct with the data fields the widget displays.",
      "2. Create src/services/{Name}Provider.h/.cpp \u2014 fetches data via NetworkManager, stores in {Name}Data.",
      "3. Create src/ui/{Name}Panel.h/.cpp \u2014 renders the data using SDL2. Inherits or follows the Widget interface.",
      "4. Register the widget in src/core/WidgetType.h and src/core/UIRegistry.h.",
      "5. If the widget exposes map overlays, integrate with MapWidget::render().",
      "6. Add REST endpoints to WebServer if needed (follow API.md conventions).",
      "7. Update feature_map.json status from 'partial'/'missing' to 'implemented' when acceptance criteria are met."
    ],
    "data_template": "// src/core/{Name}Data.h\n#pragma once\n#include <string>\n#include <vector>\n#include <ctime>\n\nstruct {Name}Data {\n    // --- domain fields ---\n    bool valid = false;       // set true once first fetch succeeds\n    time_t lastUpdate = 0;    // unix timestamp of last successful fetch\n};\n",
    "provider_template": "// src/services/{Name}Provider.h\n#pragma once\n#include \"core/{Name}Data.h\"\n\nclass {Name}Provider {\npublic:\n    static {Name}Provider& instance();\n    void update();               // called on interval by main loop\n    const {Name}Data& data() const { return _data; }\nprivate:\n    {Name}Provider() = default;\n    {Name}Data _data;\n    time_t _nextFetch = 0;\n    static constexpr int FETCH_INTERVAL_S = 300;\n};\n",
    "panel_template": "// src/ui/{Name}Panel.h\n#pragma once\n#include <SDL2/SDL.h>\n#include \"services/{Name}Provider.h\"\n\nclass {Name}Panel {\npublic:\n    void setBounds(SDL_Rect r) { _bounds = r; }\n    void render(SDL_Renderer* ren);\n    bool onTouch(int x, int y);  // return true if consumed\n    std::string getDebugData() const;\nprivate:\n    SDL_Rect _bounds{};\n};\n",
    "important_notes": [
      "NetworkManager handles HTTP. Call NetworkManager::instance().get(url) \u2014 it returns cached data when ETag/Last-Modified hasn't changed.",
      "ConfigManager::instance().get(key, default) for reading user settings. ConfigManager::instance().set(key, value) + save() to persist.",
      "Theme.h has all color constants. Use Theme::TEXT, Theme::ACCENT, etc. \u2014 never hardcode SDL_Color values.",
      "FontManager handles scaled TTF fonts. Never load your own TTF file.",
      "SDL coordinates: (0,0) is top-left. _bounds.x/y is the panel's top-left corner.",
      "All render() calls happen on the main thread. Providers run on a background thread. Use a mutex or std::atomic if sharing state.",
      "The WebServer debug endpoint /debug/widgets calls getDebugData() on all registered panels \u2014 always implement it."
    ]
  },
  "api_reference": {
    "description": "The embedded WebServer exposes a REST API. Full docs in API.md in the repo root. Key endpoints for contributor awareness:",
    "base_url": "http://localhost:{port}",
    "endpoints": [
      {
        "method": "GET",
        "path": "/live.jpg",
        "description": "JPEG screenshot of current display. Used by remote clients."
      },
      {
        "method": "GET",
        "path": "/debug/widgets",
        "description": "JSON dump of all registered widgets and their getDebugData() output."
      },
      {
        "method": "GET",
        "path": "/debug/click",
        "description": "Simulates a touch event at x,y. Params: ?x=N&y=N"
      },
      {
        "method": "GET",
        "path": "/set_touch",
        "description": "Inject touch event. Params: ?x=N&y=N"
      },
      {
        "method": "GET",
        "path": "/set_char",
        "description": "Inject keyboard character. Params: ?c=X"
      },
      {
        "method": "GET",
        "path": "/get_dx.txt",
        "description": "Returns DX location: grid, lat, lon, distance (km), bearing (degrees)."
      },
      {
        "method": "GET",
        "path": "/set_mappos",
        "description": "Programmatically set DE or DX position. Params: ?lat=F&lon=F&target=de|dx \u2014 returns JSON with computed Maidenhead grid."
      }
    ],
    "conventions": [
      "All write endpoints should eventually be protected by token auth (password_auth feature \u2014 currently missing).",
      "Return JSON for structured data, plain text for simple values.",
      "New endpoints should follow the existing naming pattern and be documented in API.md."
    ]
  },
  "original_vs_next": {
    "description": "Key architectural differences between Elwood's original and hamclock-next. Essential context for anyone touching both codebases.",
    "differences": [
      {
        "aspect": "Rendering Backend",
        "original": "Custom framebuffer abstraction + X11/EGL/ESP32 display HAL. RGB565 color format.",
        "next": "SDL2 with full RGBA. SDL_ttf for fonts, SDL_image for textures. Runs anywhere SDL2 runs."
      },
      {
        "aspect": "Code Organization",
        "original": "Flat directory of .cpp files, many 30K\u2013207K lines. Global functions, global state.",
        "next": "Layered: core/ \u2192 services/ \u2192 ui/ \u2192 network/. Class-per-widget. No globals except singletons."
      },
      {
        "aspect": "Font / Text Rendering",
        "original": "Custom seven-segment renderer (sevenseg.cpp), custom font bitmaps.",
        "next": "SDL_ttf with FontManager. seven_segment feature is not_needed \u2014 TTF fonts cover all cases."
      },
      {
        "aspect": "Satellite Tracking",
        "original": "Plan 13 orbital propagation (P13.cpp). P13 is a classic algorithm from 1983.",
        "next": "libpredict v2 (modern successor to P13). Same math, cleaner API, actively maintained."
      },
      {
        "aspect": "Configuration Storage",
        "original": "NVRAM abstraction (nvram.cpp) \u2014 maps to ESP32 Preferences or flat file. setup.cpp is 207K.",
        "next": "JSON file via ConfigManager. setup.cpp equivalent is SetupScreen.cpp \u2014 a fraction of the size."
      },
      {
        "aspect": "Networking",
        "original": "wifi.cpp (78K) \u2014 custom HTTP stack, WiFi management for ESP32, connection pooling.",
        "next": "libcurl via NetworkManager. ETag/Last-Modified caching built in. libcurl handles TLS, redirects, timeouts."
      },
      {
        "aspect": "Web Server",
        "original": "webserver.cpp (142K) + liveweb.cpp (32K). Monolithic handler.",
        "next": "WebServer.cpp \u2014 lean, documented REST API. Endpoints registered per-feature."
      },
      {
        "aspect": "Layout",
        "original": "Hardcoded 800x480 (ESP32 display size). Pixel positions are magic numbers throughout.",
        "next": "LayoutManager + PaneContainer. Responsive. Widgets get a setBounds(SDL_Rect) call."
      },
      {
        "aspect": "Hardware Features",
        "original": "I2C BME280, CPU temp via sysfs, GPIO brightness PWM, GPS NMEA, OTA firmware update.",
        "next": "Desktop-first. Hardware features (BME280, GPS, brightness PWM, OTA) are missing \u2014 low priority unless RPi-specific build target is added."
      },
      {
        "aspect": "Map Projections",
        "original": "Azimuthal equidistant (primary), Robinson, Mercator, sphere projection.",
        "next": "Azimuthal equidistant (Phase 26: high-fidelity with NASA Black Marble night lights). Robinson (v0.7B) and Mercator (v0.8B) projections implemented and selectable via MapViewMenu."
      }
    ]
  },
  "feature_status_summary": {
    "total": 71,
    "implemented": 67,
    "partial": 1,
    "missing": 3,
    "not_needed": 2,
    "percent_done": "~95% (68/71 parity features per parity.md â€” 2026-02-20)",
    "notes": "v0.9B sprint complete: PropEngine MUF/REL/TOA grids, MufRtProvider KC2G integration, POTA/SOTA map pins (SOTA partial due to coordinate resolution), WxMb weather overlay. Missing: cloud_cover_overlay, wx_precipitation_overlay, bme280_sensor."
  },
  "implemented_features": [
    {
      "feature_id": "radio_control",
      "name": "Radio CAT Control",
      "next_files": [
        "src/services/RigService.cpp",
        "src/core/RigData.h"
      ],
      "notes": "Hamlib rigctld integration."
    },
    {
      "feature_id": "rotator_gimbal",
      "name": "Rotator/Gimbal Control",
      "next_files": [
        "src/services/RotatorService.cpp",
        "src/ui/GimbalPanel.cpp"
      ],
      "notes": "Hamlib rotctld integration."
    },
    {
      "feature_id": "brightness_control",
      "name": "Brightness/Dimming",
      "next_files": [
        "src/core/BrightnessManager.cpp",
        "src/core/DisplayPower.cpp"
      ],
      "notes": "Sysfs based for RPi/x86."
    },
    {
      "feature_id": "cpu_temp",
      "name": "CPU Monitoring",
      "next_files": [
        "src/core/CPUMonitor.cpp",
        "src/ui/CPUTempPanel.cpp"
      ]
    },
    {
      "feature_id": "qrz_lookup",
      "name": "QRZ.com Lookup",
      "next_files": [
        "src/services/QRZProvider.cpp"
      ]
    },
    {
      "feature_id": "clock_callsign",
      "name": "Clock & Callsign Display",
      "next_files": [
        "src/ui/CallsignClock.cpp",
        "src/ui/TimePanel.cpp",
        "src/ui/ClockAuxPanel.cpp"
      ],
      "notes": "Split into 3 widgets. Stopwatch is in CountdownPanel."
    },
    {
      "feature_id": "world_map",
      "name": "World Map",
      "next_files": [
        "src/ui/MapWidget.cpp",
        "src/ui/MapWidget.h"
      ],
      "notes": "Phase 26 complete: azimuthal projection, NASA Blue Marble + Black Marble night lights, day/night terminator, great circles, tooltips, DE/DX markers. Missing: Robinson, Mercator projections."
    },
    {
      "feature_id": "de_info",
      "name": "DE Info Panel",
      "next_files": [
        "src/ui/DEInfo.cpp",
        "src/ui/DEInfo.h"
      ]
    },
    {
      "feature_id": "dx_info",
      "name": "DX Info Panel",
      "next_files": [
        "src/ui/DXPanel.cpp",
        "src/ui/DXPanel.h"
      ]
    },
    {
      "feature_id": "live_spots",
      "name": "Live Spots (PSK Reporter / WSPRnet / RBN)",
      "next_files": [
        "src/services/LiveSpotProvider.cpp",
        "src/ui/LiveSpotPanel.cpp"
      ],
      "notes": "Source selector cycle button in setup overlay: PSK Reporter (XML API), WSPRnet (db1.wspr.live ClickHouse SQL, FORMAT CSV, matching original HamClock), RBN (aggregated from DXClusterDataStore). All three sources respect ofDe/byDe mode and callsign-vs-grid filter. Subtitle updates to reflect active source. WSPR bands mapped to MHz IDs per original HamClock."
    },
    {
      "feature_id": "dst_index",
      "name": "Geomagnetic Disturbance (Dst)",
      "next_files": [
        "src/ui/DstPanel.cpp",
        "src/core/DstStore.h"
      ]
    },
    {
      "feature_id": "moon",
      "name": "Moon Phase & Position",
      "next_files": [
        "src/services/MoonProvider.cpp",
        "src/ui/MoonPanel.cpp"
      ],
      "notes": "Includes EME path loss."
    },
    {
      "feature_id": "weather_dx",
      "name": "Weather at DX Location",
      "next_files": [
        "src/ui/DXPanel.cpp",
        "src/ui/DXSatPane.cpp"
      ],
      "notes": "Integrated into DXPanel. Temp/Hum/Pressure/Wind displayed."
    },
    {
      "feature_id": "sdo_images",
      "name": "SDO Solar Images",
      "next_files": [
        "src/services/SDOProvider.cpp",
        "src/ui/SDOPanel.cpp"
      ]
    },
    {
      "feature_id": "drap",
      "name": "D-Region Absorption Predictions",
      "next_files": [
        "src/services/DRAPProvider.cpp",
        "src/ui/DRAPPanel.cpp"
      ]
    },
    {
      "feature_id": "aurora",
      "name": "Aurora Forecast",
      "next_files": [
        "src/services/AuroraProvider.cpp",
        "src/ui/AuroraPanel.cpp"
      ]
    },
    {
      "feature_id": "rss_banner",
      "name": "RSS News Banner",
      "next_files": [
        "src/services/RSSProvider.cpp",
        "src/ui/RSSBanner.cpp"
      ]
    },
    {
      "feature_id": "web_server",
      "name": "Embedded Web Server",
      "next_files": [
        "src/network/WebServer.cpp",
        "src/network/WebServer.h"
      ],
      "notes": "Full API in API.md. Phase 4 endpoints added: /get_dx.txt, /set_mappos."
    },
    {
      "feature_id": "network_manager",
      "name": "Network Manager",
      "next_files": [
        "src/network/NetworkManager.cpp",
        "src/network/NetworkManager.h"
      ],
      "notes": "libcurl + ETag/Last-Modified caching."
    },
    {
      "feature_id": "dxpeditions",
      "name": "DXpedition Tracker",
      "next_files": [
        "src/ui/ActivityPanels.cpp",
        "src/ui/ActivityPanels.h"
      ],
      "notes": "Implemented as DXPedPanel inside ActivityPanels."
    },
    {
      "feature_id": "watchlist",
      "name": "Callsign Watchlist",
      "next_files": [
        "src/ui/WatchlistPanel.cpp",
        "src/core/WatchlistStore.h",
        "src/core/WatchlistHitStore.h"
      ]
    },
    {
      "feature_id": "eme_tool",
      "name": "EME Tool",
      "next_files": [
        "src/ui/EMEToolPanel.cpp",
        "src/core/MoonData.h"
      ]
    },
    {
      "feature_id": "santa_tracker",
      "name": "Santa Tracker",
      "next_files": [
        "src/core/SantaStore.h",
        "src/ui/MapWidget.cpp"
      ],
      "notes": "Active Dec 24/25. Overlay on MapWidget."
    },
    {
      "feature_id": "history_panel",
      "name": "History Panel",
      "next_files": [
        "src/services/HistoryProvider.cpp",
        "src/ui/HistoryPanel.cpp"
      ],
      "notes": "New in hamclock-next. No original equivalent."
    },
    {
      "feature_id": "local_panel",
      "name": "Local Info Panel",
      "next_files": [
        "src/ui/LocalPanel.cpp"
      ],
      "notes": "New in hamclock-next."
    },
    {
      "feature_id": "list_panel",
      "name": "Generic List Panel (infrastructure)",
      "next_files": [
        "src/ui/ListPanel.cpp"
      ]
    },
    {
      "feature_id": "pane_container",
      "name": "Pane Container / Layout",
      "next_files": [
        "src/ui/PaneContainer.cpp",
        "src/ui/LayoutManager.h"
      ]
    },
    {
      "feature_id": "debug_overlay",
      "name": "Debug Overlay",
      "next_files": [
        "src/ui/DebugOverlay.h"
      ]
    },
    {
      "feature_id": "color_theme",
      "name": "Color Theme System",
      "next_files": [
        "src/core/Theme.h"
      ],
      "notes": "Use Theme:: constants. Never hardcode SDL_Color."
    },
    {
      "feature_id": "gps_nmea",
      "name": "GPS/NMEA DE Auto-Set",
      "next_files": [
        "src/services/GPSProvider.cpp",
        "src/services/GPSProvider.h"
      ],
      "notes": "gpsd TCP client. Connects to localhost:2947, parses TPV JSON. Validates mode>=2 (2D/3D fix), throttles updates to 60s, distance-gates at 500m. On qualifying fix: updates state->deLocation, config.lat/lon/grid. UI toggle in Setup \u2192 Identity tab. v0.7 blocker \u2014 completed 2026-02-17."
    },
    {
      "feature_id": "rbn",
      "name": "Reverse Beacon Network",
      "next_files": [
        "src/services/RBNProvider.cpp",
        "src/services/RBNProvider.h"
      ],
      "notes": "Background Telnet client to telnet.reversebeacon.net:7000. Parses DX de lines (same format as DX Cluster). Feeds spots into shared DXClusterDataStore \u2014 RBN beacons appear in DX Cluster panel and map overlay. Enable toggle in Setup \u2192 Spotting tab. 30s reconnect on disconnect."
    },
    {
      "feature_id": "web_only_mode",
      "name": "Headless --web-only Mode",
      "next_files": [
        "src/main.cpp",
        "src/network/WebServer.h",
        "src/network/WebServer.cpp"
      ],
      "notes": "--web-only CLI flag: hidden SDL window (SDL_WINDOW_HIDDEN), forced software renderer (guarantees SDL_RenderReadPixels works), WebServer::alwaysCapture_ keeps /live.jpg always fresh. URL printed to stdout. All panels and REST API endpoints work identically to display mode."
    },
    {
      "feature_id": "xray_flux",
      "name": "X-Ray Flux History Plot",
      "next_files": [
        "src/services/HistoryProvider.cpp",
        "src/services/HistoryProvider.h"
      ],
      "notes": "NOAA GOES 7-day JSON (1-8A channel). Daily peak grouping. log10 scale, range -9 to -3 (A through X+ flare classes). HISTORY_XRAY widget type. Displayed by HistoryPanel with fixed min/max labels."
    },
    {
      "feature_id": "on_the_air_enhanced",
      "name": "On The Air Enhanced (POTA/SOTA filter + map pins)",
      "next_files": [
        "src/services/ActivityProvider.cpp",
        "src/ui/ActivityPanels.cpp",
        "src/ui/MapWidget.cpp"
      ],
      "notes": "POTA lat/lon resolved from grid4 field via Astronomy::gridToLatLon(). ONTAPanel POTA/SOTA/ALL filter chip in title row \u2014 tap chip to cycle ALL\u2192POTA\u2192SOTA\u2192ALL; accent color when filtered. Persisted as activity.onta_filter in ConfigManager. MapWidget::renderActivityPins(): green squares = POTA, orange squares = SOTA. Wired via setActivityStore()."
    },
    {
      "feature_id": "adif_filter",
      "name": "ADIF Log Viewer Band/Mode Filter",
      "next_files": [
        "src/ui/ADIFPanel.cpp",
        "src/ui/ADIFPanel.h"
      ],
      "notes": "Header-area click cycles band (left half) or mode (right half). Filter chip displayed in header: '[40m FT8]' etc. Bands: All,160m,80m,60m,40m,30m,20m,17m,15m,12m,10m,6m,2m. Modes: All,CW,SSB,FT8,FT4,RTTY,AM,FM. Filter resets scroll position."
    },
    {
      "feature_id": "brightness_control",
      "name": "Brightness/Dimming Control",
      "next_files": [
        "src/core/BrightnessManager.cpp",
        "src/core/BrightnessManager.h",
        "src/core/DisplayPower.cpp"
      ],
      "notes": "Sysfs-based for Linux (backlight). Day/night schedule with configurable dim/bright times. Manual slider in Setup \u2192 Display tab. Smooth transition via SDL texture overlay."
    },
    {
      "feature_id": "radio_control",
      "name": "Radio CAT Control (Hamlib rigctld)",
      "next_files": [
        "src/services/RigService.cpp",
        "src/services/RigService.h"
      ],
      "notes": "Hamlib rigctld TCP client. Set frequency from DX spot click when auto-tune enabled. Config in Setup \u2192 Rig tab (host/port). Windows-compatible via Winsock2 guards."
    },
    {
      "feature_id": "password_auth",
      "name": "Web Server Password Auth",
      "next_files": [
        "src/network/WebServer.cpp",
        "src/core/ConfigManager.h"
      ],
      "notes": "config.webPassword (empty = no auth). set_pre_routing_handler checks Basic auth on control endpoints. Stored in config.json under security.web_password."
    },
    {
      "feature_id": "cpu_temp",
      "name": "CPU Temperature Monitor",
      "next_files": [
        "src/core/MemoryMonitor.h"
      ],
      "notes": "Reads /sys/class/thermal/thermal_zone0/temp on Linux. Used in MemoryMonitor for health logging. Display in LocalPanel."
    },
    {
      "feature_id": "voacap_map_overlay",
      "name": "VOACAP Propagation Overlay",
      "next_files": [
        "src/core/PropEngine.cpp",
        "src/ui/MapWidget.cpp"
      ],
      "notes": "Local C++ calculation of MUF, Reliability, and TOA grids. WorkerService threaded."
    },
    {
      "feature_id": "muf_rt_map_overlay",
      "name": "KC2G Real-Time MUF Overlay",
      "next_files": [
        "src/services/MufRtProvider.cpp",
        "src/ui/MapWidget.cpp"
      ],
      "notes": "Direct fetch and warp of KC2G MUF imagery."
    }
  ],
  "partial_features": {
    "description": "As of v0.7B (2026-02-17) all previously-partial features are now implemented. See implemented_features for the complete list. This section is retained as an archive of what was completed during the v0.7B sprint.",
    "completed_in_v0_7B": [
      "satellite_tracking",
      "dx_cluster",
      "solar_flux",
      "kp_index",
      "sunspot_number",
      "xray_flux",
      "solar_wind",
      "bz_bt",
      "noaa_space_weather",
      "band_conditions",
      "weather_de",
      "contests",
      "on_the_air",
      "adif",
      "ncdxf_beacons",
      "countdown_timer",
      "setup_config",
      "widget_selector",
      "prefix_lookup",
      "maidenhead",
      "rotator_gimbal"
    ],
    "items_ARCHIVE": [
      {
        "feature_id": "satellite_tracking",
        "name": "Satellite Tracking",
        "next_files": [
          "src/core/SatelliteManager.cpp",
          "src/ui/SatPanel.cpp",
          "src/ui/DXSatPane.cpp",
          "src/core/OrbitPredictor.cpp"
        ],
        "original_reference": "earthsat.cpp (76K), P13.cpp, sattool.cpp",
        "what_exists": "SatelliteManager, SatPanel, DXSatPane, OrbitPredictor classes exist. libpredict v2 used instead of P13.",
        "what_is_needed": "Verify TLE fetching and update cycle. Complete polar plot rendering in SatPanel. Satellite footprint overlay on MapWidget. Rise/set prediction display. Satellite selection UI (sattool equivalent).",
        "acceptance_criteria": [
          "Satellite selection from TLE catalog",
          "Real-time position tracking on map",
          "Polar plot showing current pass",
          "Rise/set time predictions",
          "Satellite footprint on map",
          "Next-pass scheduling"
        ]
      },
      {
        "feature_id": "dx_cluster",
        "name": "DX Cluster",
        "next_files": [
          "src/services/DXClusterProvider.cpp",
          "src/ui/DXClusterPanel.cpp",
          "src/ui/DXClusterSetup.cpp",
          "src/core/DXClusterData.h"
        ],
        "original_reference": "dxcluster.cpp (40K)",
        "what_exists": "Provider, Panel, Setup, and Data classes exist.",
        "what_is_needed": "Verify Telnet connection to cluster nodes. Spot parsing (DX de spotter freq comment). Map overlay with bearing lines. Auto-reconnect logic. Cluster node config UI.",
        "acceptance_criteria": [
          "Connect to DX Cluster node via Telnet",
          "Parse and display DX spots in scrollable list",
          "Spots plotted on map with bearing lines",
          "Cluster node configuration (host/port/login)",
          "Auto-reconnect on disconnect"
        ]
      },
      {
        "feature_id": "solar_flux",
        "name": "Solar Flux (SFI) Plot",
        "next_files": [
          "src/ui/SolarPanel.cpp",
          "src/core/SolarData.h"
        ],
        "original_reference": "spacewx.cpp (63K), symbol PLOT_CH_FLUX",
        "what_is_needed": "Verify SolarPanel implements full 30-day time-series plot, not just current value. NOAA/SWPC data source.",
        "acceptance_criteria": [
          "30-day SFI time-series plot",
          "Current SFI value prominently shown",
          "Color coding for propagation conditions"
        ]
      },
      {
        "feature_id": "kp_index",
        "name": "Planetary K-Index",
        "next_files": [
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_KP",
        "what_is_needed": "Confirm SpaceWeatherPanel renders Kp bar chart. Storm level indicators G1-G5. NOAA/SWPC data source.",
        "acceptance_criteria": [
          "Color-coded Kp bar chart",
          "Current Kp value",
          "Storm-level indicators (G1-G5)"
        ]
      },
      {
        "feature_id": "sunspot_number",
        "name": "Sunspot Number (SSN)",
        "next_files": [
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_SSN",
        "what_is_needed": "Confirm SSN is rendered (may share SpaceWeatherPanel with Kp). NOAA/SWPC data.",
        "acceptance_criteria": [
          "SSN time-series plot",
          "Current SSN value shown"
        ]
      },
      {
        "feature_id": "xray_flux",
        "name": "X-Ray Flux",
        "next_files": [
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_XRAY",
        "what_is_needed": "GOES X-ray data from NOAA/SWPC. Flare class indicators (C/M/X class flares). Time-series plot.",
        "acceptance_criteria": [
          "GOES X-ray time-series",
          "Flare class indicators (C/M/X)",
          "Current flux level shown"
        ]
      },
      {
        "feature_id": "solar_wind",
        "name": "Solar Wind",
        "next_files": [
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_SOLWIND",
        "what_is_needed": "DSCOVR/ACE solar wind data. Speed and density time-series.",
        "acceptance_criteria": [
          "Solar wind speed and density time-series",
          "Current values shown"
        ]
      },
      {
        "feature_id": "bz_bt",
        "name": "Bz/Bt Interplanetary Magnetic Field",
        "next_files": [
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_BZBT",
        "what_is_needed": "IMF Bz and Bt from NOAA/SWPC. Southward Bz (negative) is the key geomagnetic storm driver \u2014 highlight it.",
        "acceptance_criteria": [
          "Bz and Bt time-series",
          "Southward Bz highlighted as storm indicator"
        ]
      },
      {
        "feature_id": "noaa_space_weather",
        "name": "NOAA Space Weather Scales",
        "next_files": [
          "src/services/NOAAProvider.cpp",
          "src/ui/SpaceWeatherPanel.cpp"
        ],
        "original_reference": "spacewx.cpp, symbol PLOT_CH_NOAASPW",
        "what_is_needed": "NOAAProvider fetches R/S/G scales. SpaceWeatherPanel renders color-coded current levels.",
        "acceptance_criteria": [
          "R (radio blackout), S (solar radiation), G (geomagnetic) levels displayed",
          "Color-coded alert status"
        ]
      },
      {
        "feature_id": "band_conditions",
        "name": "Band Conditions (VOACAP)",
        "next_files": [
          "src/services/BandConditionsProvider.cpp",
          "src/ui/BandConditionsPanel.cpp",
          "src/core/BandConditionsData.h"
        ],
        "original_reference": "bands.cpp (7K), symbol PLOT_CH_BC",
        "what_is_needed": "VOACAP API query for DE-DX path. Per-band reliability bars (160m\u20136m). Update when DX location changes.",
        "acceptance_criteria": [
          "VOACAP predictions per band",
          "Color-coded reliability bars",
          "Updates on DX location change"
        ]
      },
      {
        "feature_id": "weather_de",
        "name": "Weather at DE Location",
        "next_files": [
          "src/services/WeatherProvider.cpp",
          "src/ui/WeatherPanel.cpp"
        ],
        "original_reference": "wx.cpp (30K), symbol PLOT_CH_DEWX",
        "what_is_needed": "WeatherProvider completeness unclear. Verify temperature, humidity, wind, conditions display. Auto-update interval.",
        "acceptance_criteria": [
          "Temperature, humidity, wind, conditions for DE location",
          "Periodic auto-update"
        ]
      },
      {
        "feature_id": "contests",
        "name": "Contest Calendar",
        "next_files": [
          "src/services/ContestProvider.cpp",
          "src/ui/ContestPanel.cpp",
          "src/core/ContestData.h"
        ],
        "original_reference": "contests.cpp (22K), symbol PLOT_CH_CONTESTS",
        "what_is_needed": "Complete. All criteria met as of v0.8B.",
        "acceptance_criteria": [
          "Contest list with name, dates, mode, bands \u2705",
          "Active contests highlighted \u2705",
          "Tappable for details \u2705 (modal popup: title, start/end times, URL \u2014 ContestPanel v0.8B)"
        ]
      },
      {
        "feature_id": "on_the_air",
        "name": "On The Air (POTA/SOTA)",
        "next_files": [
          "src/services/ActivityProvider.cpp",
          "src/ui/ActivityPanels.cpp",
          "src/core/ActivityData.h"
        ],
        "original_reference": "ontheair.cpp (27K), symbol PLOT_CH_ONTA",
        "what_is_needed": "POTA and SOTA APIs. Activator list with callsign, reference, frequency, mode. Map spots. Toggle between POTA and SOTA.",
        "acceptance_criteria": [
          "POTA activator list from API",
          "SOTA activator list from API",
          "Spots on map",
          "POTA/SOTA toggle"
        ]
      },
      {
        "feature_id": "adif",
        "name": "ADIF Log Viewer",
        "next_files": [
          "src/services/ADIFProvider.cpp",
          "src/ui/ADIFPanel.cpp"
        ],
        "original_reference": "adif.cpp (16K) + adif_parser.cpp (24K), symbol PLOT_CH_ADIF",
        "what_is_needed": "ADIF file parsing (the format is well-documented). QSO list with callsign/date/band/mode. Map overlay of QSO locations. File selection dialog.",
        "acceptance_criteria": [
          "Parse ADIF files",
          "QSO list display",
          "QSO locations on map",
          "Filter by band/mode/date"
        ]
      },
      {
        "feature_id": "ncdxf_beacons",
        "name": "NCDXF Beacon Monitor",
        "next_files": [
          "src/services/BeaconProvider.h",
          "src/ui/BeaconPanel.cpp",
          "src/core/BeaconData.h"
        ],
        "original_reference": "ncdxf.cpp (10K), symbol BRB_SHOW_BEACONS",
        "what_is_needed": "BeaconProvider.h exists but no .cpp \u2014 likely incomplete. NCDXF beacon schedule is published and deterministic (time-based, no API needed). Implement schedule logic. Highlight currently transmitting beacon.",
        "acceptance_criteria": [
          "NCDXF beacon schedule display",
          "Currently transmitting beacon highlighted",
          "Beacon location on map",
          "Cycle through bands (14-28 MHz)"
        ]
      },
      {
        "feature_id": "countdown_timer",
        "name": "Countdown Timer",
        "next_files": [
          "src/ui/CountdownPanel.cpp"
        ],
        "original_reference": "stopwatch.cpp (97K), symbol PLOT_CH_COUNTDOWN",
        "what_is_needed": "Target date/time input. Remaining time display (d/h/m/s). Visual/audio alarm at zero. Event name label.",
        "acceptance_criteria": [
          "Set target date/time",
          "Display d/h/m/s remaining",
          "Alarm at zero",
          "Configurable event name"
        ]
      },
      {
        "feature_id": "rotator_gimbal",
        "name": "Rotator/Gimbal Control",
        "next_files": [
          "src/ui/GimbalPanel.cpp"
        ],
        "original_reference": "gimbal.cpp (36K), symbol PLOT_CH_GIMBAL",
        "what_is_needed": "GimbalPanel UI exists. Need hardware serial integration for rotator protocols (Yaesu GS-232, Easycomm). Compass display. Rotate-to-bearing command.",
        "acceptance_criteria": [
          "Current rotator azimuth display",
          "Rotate to target bearing command",
          "Visual compass",
          "Support GS-232 or Easycomm protocol"
        ]
      },
      {
        "feature_id": "setup_config",
        "name": "Setup & Configuration",
        "next_files": [
          "src/core/ConfigManager.cpp",
          "src/ui/SetupScreen.cpp"
        ],
        "original_reference": "setup.cpp (207K), configs.cpp (28K), nvram.cpp (20K)",
        "what_is_needed": "SetupScreen completeness unclear. Verify all config items: callsign, location (grid/lat-lon/map-click), DX Cluster host/port, display preferences. Config persistence via ConfigManager.",
        "acceptance_criteria": [
          "Callsign entry",
          "Location setting (grid or lat/lon or map click)",
          "DX Cluster configuration",
          "Display preferences",
          "Config persisted to JSON on disk"
        ]
      },
      {
        "feature_id": "widget_selector",
        "name": "Widget/Pane Selector",
        "next_files": [
          "src/ui/WidgetSelector.cpp",
          "src/core/WidgetType.h",
          "src/core/UIRegistry.h"
        ],
        "original_reference": "menu.cpp (31K), plotmgmnt.cpp (23K)",
        "what_is_needed": "Long-press/tap on pane opens selector. List available widgets. Assign widget to pane. Persist pane assignments.",
        "acceptance_criteria": [
          "Tap/long-press opens widget selector",
          "Widget list for pane",
          "Assignment replaces current widget",
          "Persisted across restarts"
        ]
      },
      {
        "feature_id": "prefix_lookup",
        "name": "Callsign Prefix Lookup",
        "next_files": [
          "src/core/PrefixManager.cpp"
        ],
        "original_reference": "prefixes.cpp (41K) + callsign.cpp (20K)",
        "what_is_needed": "PrefixManager exists. Verify DXCC database is complete and returns country, CQ zone, ITU zone, and coordinates for callsign prefixes.",
        "acceptance_criteria": [
          "Callsign \u2192 DXCC entity lookup",
          "Returns country, CQ zone, ITU zone",
          "Approximate coordinates",
          "Handles special prefixes and portable suffixes"
        ]
      },
      {
        "feature_id": "maidenhead",
        "name": "Maidenhead Grid System",
        "next_files": [],
        "original_reference": "maidenhead.cpp (4K)",
        "what_is_needed": "Grid conversion functions may be embedded in SetupScreen and DEInfo. Create src/core/Maidenhead.h with standalone ll2grid(lat, lon) and grid2ll(grid) functions. Ensure consistent use across codebase.",
        "acceptance_criteria": [
          "ll2grid() and grid2ll() as standalone utility",
          "Grid square labels on map edges",
          "Grid input supported in setup screen"
        ]
      }
    ]
  },
  "missing_features": {
    "description": "As of v0.8B (2026-02-18), only 1 feature remains genuinely missing (deferred to v0.9). robinson_projection and mercator_projection were completed. See implemented_from_this_list.",
    "implemented_from_this_list": [
      "brightness_control (BrightnessManager.cpp, sysfs + day/night schedule)",
      "radio_control (RigService.cpp, Hamlib rigctld)",
      "gps_nmea (GPSProvider.cpp, gpsd TCP + TPV auto-set DE)",
      "qrz_lookup (QRZProvider.cpp, XML API + config storage)",
      "password_auth (WebServer.cpp, set_pre_routing_handler + config.webPassword)",
      "cpu_temp (CPUMonitor.cpp, /sys/class/thermal)",
      "robinson_projection (MapWidget.cpp v0.7B, projection enum + vertex generator, selectable via MapViewMenu)",
      "mercator_projection (MapWidget.cpp v0.8B, selectable via MapViewMenu)"
    ],
    "items": [
      {
        "feature_id": "bme280_sensor",
        "name": "BME280 Environmental Sensor",
        "original_reference": "BME280.cpp (16K)",
        "priority": "low",
        "target_version": "v0.9",
        "notes": "I2C hardware \u2014 only relevant for RPi with sensor attached. Plots temperature, pressure, humidity, dew point.",
        "acceptance_criteria": [
          "I2C BME280 read via linux i2c-dev",
          "Temperature/pressure/humidity display",
          "Dew point calculation",
          "Historical plots via HistoryPanel"
        ]
      }
    ]
  },
  "not_needed_features": {
    "description": "These original features are explicitly NOT being ported. Document for contributor clarity.",
    "items": [
      {
        "feature_id": "seven_segment",
        "name": "Seven-Segment Display Renderer",
        "reason": "sevenseg.cpp (11K) rendered custom bitmap seven-segment digits. SDL2 + SDL_ttf provides proper font rendering. The aesthetic can be replicated with a seven-segment TTF font if desired, but the custom renderer is unnecessary."
      },
      {
        "feature_id": "ota_update",
        "name": "Over-The-Air Firmware Update",
        "reason": "OTAupdate.cpp (14K) was ESP32-specific \u2014 it flashed new firmware to the microcontroller. Desktop Linux does not update this way. Use OS package manager or git pull + rebuild."
      }
    ]
  },
  "contribution_guide": {
    "for_new_contributors": [
      "Read this MCP and the API.md in the repo root before touching any code.",
      "Check missing_features for remaining deferred work (bme280_sensor only \u2014 all map projections now implemented). All other features are implemented.",
      "Follow the widget_scaffolding steps. Do not deviate from the Provider/Panel/Data naming pattern.",
      "Use Theme:: color constants. Use FontManager for text. Never hardcode pixel positions \u2014 use _bounds from setBounds().",
      "Implement getDebugData() in every Panel \u2014 it feeds /debug/widgets and is essential for remote debugging.",
      "When a feature is complete, update feature_map.json: change status to 'implemented', verify acceptance criteria.",
      "Test with the WebServer: /live.jpg shows the current state, /debug/widgets shows widget health."
    ],
    "for_ai_assistants": [
      "This project uses C++20. Use modern C++ idioms: auto, range-for, std::optional, std::variant, structured bindings, if constexpr where appropriate.",
      "Do not suggest ESP32-specific code. This is a desktop/embedded Linux SDL2 application.",
      "When implementing a partial feature, check what already exists in the listed next_files before writing new code.",
      "The original codebase (master branch) is reference material for behavior, NOT for code style or architecture.",
      "libpredict v2 docs: https://github.com/la1k/libpredict \u2014 use for all satellite tracking math.",
      "libcurl is already integrated via NetworkManager. Do not add new HTTP libraries.",
      "SDL2 docs: https://wiki.libsdl.org/SDL2 \u2014 SDL_Renderer, SDL_Texture, SDL_ttf, SDL_image are all in use.",
      "When unsure about an API endpoint format, check API.md and follow the existing pattern in WebServer.cpp.",
      "feature_map.json is the source of truth for what is done, partial, or missing. Update it when you complete work."
    ],
    "code_style": [
      "2-space indentation (spaces, not tabs \u2014 actual codebase convention).",
      "Braces on same line for control flow, own line for class/function definitions.",
      "Class members with TRAILING underscore: x_, y_, width_, height_, data_, nextFetch_. NOT leading underscore.",
      "Public API first in header, private last.",
      "No raw owning pointers \u2014 use std::unique_ptr or std::shared_ptr.",
      "Colors: always use ThemeColors struct from getThemeColors(theme_) \u2014 never hardcode SDL_Color{r,g,b,a} in widget render paths.",
      "Windows portability: no localtime_r without #ifdef _WIN32 guard; no raw POSIX sockets \u2014 use DXClusterProvider.cpp as reference."
    ]
  },
  "feature_map_maintenance": {
    "description": "How to keep the MCP current as development progresses.",
    "instructions": [
      "When a partial feature's acceptance criteria are fully met, change its status to 'implemented'.",
      "When a missing feature is started, create its scaffolding files and change status to 'partial' with next.files populated.",
      "When a decision is made to permanently skip a feature, change status to 'not_needed' with a clear reason in notes.",
      "After any status change, update feature_status_summary counts.",
      "The notes field on any feature can document implementation decisions, gotchas, or references \u2014 keep it current.",
      "This file (hamclock-next-mcp.json) lives in the repo root and is the first thing AI assistants and new contributors should read."
    ]
  },
  "recent_phases": {
    "description": "Completed development phases in chronological order. Most recent first.",
    "phase_37": {
      "name": "Raspberry Pi Memory Optimization & Segfault Prevention",
      "completed": "2026-02-16",
      "summary": "Resolved critical 'Cannot allocate memory' errors and subsequent segfaults on Raspberry Pi KMSDRM backend through tooltip texture caching, robust NULL checks, and low-memory rendering modes.",
      "problem": "Frequent texture allocation/deallocation (180 creates per 3 seconds for tooltips) exhausted DRM descriptor pool on RPi. Unchecked NULL pointers cascaded into segfaults. Heavy SDL_RenderGeometry usage (96\u00d748 grids = 4608 vertices) triggered internal buffer reallocations.",
      "solutions": [
        "Tooltip texture caching: Textures now cached per tooltip text, only regenerated on text change (99% reduction: 180\u21921-2 allocations)",
        "Robust NULL checks: Added checks after all SDL_CreateTexture, fontMgr_.renderText(), and texMgr_.get() calls with SDL_GetError() logging",
        "Low-memory mode: Automatic 75% mesh density reduction for KMSDRM (96\u00d748\u219248\u00d724 grids for night overlay and Robinson projection)",
        "Reduced geometry complexity: Great circle paths 250\u2192100 segments, satellite footprint 72\u219236 segments",
        "Enhanced diagnostics: SDL_GetError() messages with context (surface dimensions, texture keys, byte counts)"
      ],
      "key_changes": [
        "MapWidget.h: Added Tooltip::cachedTexture, cachedText, cachedW, cachedH fields",
        "MapWidget.cpp: renderTooltip() only creates textures on text change, cleanup in destructor and on hide",
        "MapWidget.cpp: Dynamic mesh density based on useCompatibilityRenderPath_ flag",
        "TextureManager.h: Enhanced error logging with SDL_GetError()",
        "FontManager.h: Added detailed error logging with surface dimensions and text context"
      ],
      "files_modified": [
        "src/ui/MapWidget.h",
        "src/ui/MapWidget.cpp",
        "src/ui/TextureManager.h",
        "src/ui/FontManager.h"
      ],
      "automatic_activation": "Low-memory optimizations automatically activate when SDL_GetCurrentVideoDriver() returns 'kmsdrm'. No configuration required.",
      "testing_required": [
        "RPi KMSDRM runtime verification with tooltip stress test (5+ minutes continuous hover)",
        "Memory monitoring during normal operation: watch -n 1 'cat /proc/meminfo | grep -E \"MemAvailable|Dirty\"'",
        "Visual quality verification: reduced mesh density should be imperceptible at 800\u00d7480",
        "FPS stability check: should remain above 50 FPS during heavy map interaction"
      ],
      "documentation": "MEMORY_FIX_SUMMARY.md",
      "validation": "Longest stable run on RPi without errors to date (user confirmed)"
    },
    "phase_38": {
      "name": "GPS DE Auto-Set (v0.7 Blocker)",
      "completed": "2026-02-17",
      "summary": "GPSProvider::processLine() fully wired. Connects to localhost:2947, parses TPV JSON, validates mode>=2, 60s throttle, 500m distance gate. Updates state->deLocation, config.lat/lon/grid on qualifying fix.",
      "key_changes": [
        "src/services/GPSProvider.cpp: processLine() implemented",
        "src/services/GPSProvider.h: removed const from config_ ref; added lastUpdate_ member",
        "CMakeLists.txt: added GPSProvider.cpp to source list",
        "src/main.cpp: GPSProvider instantiated after webServer.start() as persistent background service"
      ]
    },
    "phase_39": {
      "name": "Tier 3: xray_flux, on_the_air enhanced, adif filter",
      "completed": "2026-02-17",
      "summary": "Three medium-complexity features completing the Tier 3 sprint.",
      "key_changes": [
        "HistoryProvider: fetchXray()/processXray() \u2014 GOES 7-day JSON, daily peak, log10 scale; HISTORY_XRAY widget type",
        "ActivityProvider: POTA lat/lon from grid4 via Astronomy::gridToLatLon()",
        "ActivityPanels: ONTAPanel POTA/SOTA/ALL filter toggle (title click cycles mode \u2014 superseded by chip UI in phase_43)",
        "MapWidget: renderActivityPins() \u2014 green=POTA, orange=SOTA via setActivityStore()",
        "ADIFPanel: band/mode filter chips \u2014 left-header click cycles band, right cycles mode; chip '[40m FT8]' shown"
      ]
    },
    "phase_40": {
      "name": "RBN (Reverse Beacon Network)",
      "completed": "2026-02-17",
      "summary": "RBNProvider background Telnet client feeding into shared DXClusterDataStore. RBN spots appear in DX Cluster panel and map overlay with zero rendering changes.",
      "key_changes": [
        "src/services/RBNProvider.cpp/.h: new Telnet client (clone of DXClusterProvider pattern)",
        "ConfigManager.h: AppConfig::rbnEnabled, rbnHost fields",
        "ConfigManager.cpp: rbn section load/save",
        "CMakeLists.txt: added RBNProvider.cpp",
        "main.cpp: RBNProvider instantiated and started",
        "SetupScreen.h: rbnEnabled_, rbnToggleRect_ members"
      ]
    },
    "phase_41": {
      "name": "--web-only Headless Mode",
      "completed": "2026-02-17",
      "summary": "CLI flag for running HamClock without a display. Hidden SDL window + software renderer + alwaysCapture_ flag on WebServer ensures /live.jpg is always current.",
      "key_changes": [
        "src/main.cpp: --web-only flag parsing, SDL_WINDOW_HIDDEN, forceSoftware=true, URL print",
        "src/network/WebServer.h: setAlwaysCapture(bool), alwaysCapture_ member",
        "src/network/WebServer.cpp: needsCapture_ = alwaysCapture_ after each frame capture"
      ]
    },
    "phase_42": {
      "name": "SetupScreen RBN toggle + 100% parity",
      "completed": "2026-02-17",
      "summary": "Final wiring: RBN enable toggle rendered in Setup \u2192 Spotting tab. All 56/56 scoped features implemented. feature_map.json v1.6. hamclock-next-mcp.json v2.1.",
      "key_changes": [
        "SetupScreen.cpp: RBN section with checkbox render, click handler, setConfig/getConfig wiring",
        ".mcp/feature_map.json: bumped to v1.6; rbn and web_only added as implemented",
        ".mcp/hamclock-next-mcp.json: bumped to v2.1; feature_status_summary updated to 100%"
      ]
    },
    "phase_43": {
      "name": "Parity & UX Sprint (v0.8B)",
      "completed": "2026-02-18",
      "summary": "Five parity/UX items implemented: satellite ground track 'Path' toggle, global RSS on/off toggle, Contest detail popup, POTA/SOTA filter chip in ONTAPanel, and IonosondeProvider WASM safety fix. Parity score updated to ~91% (62/68).",
      "key_changes": [
        "ConfigManager.h/.cpp: added showSatTrack (appearance.show_sat_track) and rssEnabled (rss.enabled) config fields",
        "ConfigManager.h/.cpp: added ontaFilter (activity.onta_filter) config field",
        "DXSatPane.h/.cpp: 'Path' button in header row (blue=visible, gray=hidden); guards MapWidget::renderSatGroundTrack()",
        "RSSBanner.cpp: enabled_ flag; render/update blocked when rss.enabled=false",
        "MapWidget.cpp: RSS on/off 44\u00d722px button at top-right of map area (green/gray); positioned above RSSBanner to avoid render-order overlap",
        "ContestData.h: added dateDesc and url fields to Contest struct",
        "ContestProvider.cpp: <link> extraction \u2192 c.url; raw date description \u2192 c.dateDesc",
        "ContestPanel.h/.cpp: full rewrite \u2014 row hit-testing (rowRects_/displayedIndices_ tracked per frame), tappable popup modal (title word-wrap, status, start/end times, URL), Escape dismiss, isModalActive() override",
        "ActivityPanels.h/.cpp: ONTAPanel Filter enum (ALL/POTA/SOTA), chip overlay in title row, rebuildRows() filters by os.program, setOnFilterChanged callback",
        "main.cpp: ONTAPanel::setFilter(appCfg.ontaFilter) + setOnFilterChanged persists to config",
        "IonosondeProvider.cpp: replaced std::stod+try/catch with StringUtils::safe_stod() for WASM exception safety"
      ],
      "files_modified": [
        "src/core/ConfigManager.h",
        "src/core/ConfigManager.cpp",
        "src/core/ContestData.h",
        "src/services/ContestProvider.cpp",
        "src/ui/DXSatPane.h",
        "src/ui/DXSatPane.cpp",
        "src/ui/RSSBanner.cpp",
        "src/ui/MapWidget.cpp",
        "src/ui/ContestPanel.h",
        "src/ui/ContestPanel.cpp",
        "src/ui/ActivityPanels.h",
        "src/ui/ActivityPanels.cpp",
        "src/main.cpp"
      ],
      "gotchas": [
        "RSS button must be placed at top-right (not bottom-left) of map area \u2014 RSSBanner is a separate widget rendered AFTER MapWidget in the main loop and will paint over anything at the bottom edge.",
        "ONTAPanel lambda capture: inner setOnFilterChanged callbacks must use [&ctx] not [this] \u2014 addToPool is a [&] lambda with no enclosing class.",
        "Contest row hit-testing: rowRects_/displayedIndices_ rebuilt each frame in render() to stay correct after scroll/resize/data change.",
        "isModalActive() must return true while popup is open \u2014 PaneContainer routes all events to the active widget when modal is active."
      ]
    },
    "phase_44": {
      "name": "UI Polish Sprint",
      "completed": "2026-02-18",
      "summary": "SetupScreen: merged Appearance + Display tabs into single Display tab (7\u21926 tabs). Section headers --- Appearance --- / --- Brightness --- added. Font sizes reduced ~15-20% (title max 36, label max 20, field max 26). Active field 2px focus glow. Tab key cursor moves to end of field. DXSatPane Pth/Trk buttons get filled backgrounds and height-scaled font. Vertical spacing tightened throughout (title\u2192tab gap pad/2, footer anchor 12px fixed).",
      "files_modified": [
        "src/ui/SetupScreen.cpp",
        "src/ui/SetupScreen.h",
        "src/ui/DXSatPane.cpp"
      ],
      "gotchas": [
        "renderTabX() methods each hardcode their own content-y; all 6 must be updated consistently when changing the title\u2192tab spacing.",
        "Tab enum value indices (0-5) are used directly for tab highlight; removing Tab::Display shifted all values \u2014 onMouseUp tabValues[] must match render() tabs[]."
      ]
    },
    "phase_45": {
      "name": "Live Spots Source Selector Restoration",
      "completed": "2026-02-18",
      "summary": "Restored PSK/WSPR/RBN source selector that was missing from LiveSpotPanel setup overlay. LiveSpotProvider.fetch() now branches on config_.liveSpotSource. PSK: unchanged XML query. WSPR: db1.wspr.live ClickHouse SQL (FORMAT CSV), supports callsign or 4-char grid prefix, ofDe/byDe role (tx/rx), selected-band filter via band IN (...) using MHz IDs matching original HamClock. RBN: aggregates from shared DXClusterDataStore (Telnet stream from RBNProvider), filters by txCall/txGrid (ofDe) or rxCall/rxGrid (byDe), plots other station. LiveSpotProvider constructor now accepts optional DXClusterDataStore shared_ptr.",
      "files_modified": [
        "src/services/LiveSpotProvider.h",
        "src/services/LiveSpotProvider.cpp",
        "src/ui/LiveSpotPanel.h",
        "src/ui/LiveSpotPanel.cpp",
        "src/main.cpp"
      ],
      "gotchas": [
        "WSPR endpoint is db1.wspr.live (ClickHouse HTTP), NOT wsprnet.org \u2014 the latter has an incompatible JSON format and ignores DE/DX mode.",
        "WSPR band IDs are MHz integers {1,3,5,7,10,14,18,21,24,28,50,144}, not kHz.",
        "RBN source is read-only from DXClusterDataStore; RBNProvider still sends no Telnet filter commands (set dx filter call ...) \u2014 full firehose. Fix in T0-1."
      ]
    }
  },
  "platform_specific": {
    "description": "Platform-specific optimizations and considerations",
    "raspberry_pi": {
      "kmsdrm_backend": {
        "description": "Kernel Mode Setting Direct Rendering Manager - modern display backend for RPi",
        "detection": "SDL_GetCurrentVideoDriver() == 'kmsdrm'",
        "compatibility_mode_trigger": "useCompatibilityRenderPath_ flag set in MapWidget constructor",
        "memory_optimizations": {
          "night_overlay_grid": "96\u00d748 (4608 vertices) \u2192 48\u00d724 (1152 vertices) = 75% reduction",
          "robinson_projection_grid": "96\u00d748 \u2192 48\u00d724",
          "spot_limit": "200 \u2192 100 max rendered spots",
          "great_circle_segments": "250 \u2192 100",
          "satellite_footprint_segments": "72 \u2192 36",
          "tooltip_texture_caching": "Per-frame create/destroy \u2192 cached until text changes"
        },
        "known_issues_resolved": [
          "Cannot allocate memory errors (Phase 37)",
          "Cascade segfaults from NULL texture pointers (Phase 37)",
          "Night overlay banding/artifacts (Phase 32)",
          "Colorful noise on night side (Phase 31)"
        ]
      },
      "hardware_features": {
        "display_power": "vcgencmd display_power (HDMI) or sysfs bl_power (DSI)",
        "cpu_temperature": "/sys/class/thermal/thermal_zone0/temp",
        "brightness_control": "sysfs backlight control via BrightnessManager",
        "i2c_sensors": "BME280 support planned (low priority)"
      }
    }
  },
  "decisions": {
    "voacap_overlays": {
      "decision": "VOACAP world map overlays (MUF/REL/TOA) are the highest-priority parity gap. The open-hamclock-backend already has a complete physics engine (voacap_service.py with NumPy vectorization). The decision is to proxy to OHB rather than port the Python/NumPy physics to C++.",
      "rationale": "voacap_service.py is 722 lines of complex ionospheric physics with NumPy vectorization. Porting to C++ would be months of work and risk introducing bugs in the physics model. OHB is already in the repo. The proxy approach lets us ship parity quickly while leaving the C++ port as a future optimization.",
      "implementation_path": [
        "1. Add fetchVOACAP-MUF.pl and fetchVOACAP-TOA.pl to open-hamclock-backend (they call voacap_service.py which is already there)",
        "2. Create src/services/VoacapProvider.cpp that fetches from /api/propagation/voacap \u2192 overlay_endpoint",
        "3. Add SDL_Texture overlay blending in MapWidget (pattern: same as DX Cluster spots, but full-image texture)",
        "4. Add overlay toggle in MapViewMenu"
      ],
      "backend_free_path": "KC2G MUF-RT only \u2014 fetch https://prop.kc2g.com/renders/current/mufd-normal-now.png. No frequency/mode params. Covers the most common use case (current MUF conditions).",
      "reprojection_note": "Overlay is 660x330 equirectangular. MapWidget uses azimuthal equidistant. MVP: render overlay in flat projection panel. Full parity: reproject 660x330 grid pixels to azimuthal coordinates in MapWidget::render() using the inverse of screenToLatLon().",
      "date_added": "2026-02-18"
    }
  },
  "gotchas": {
    "propagation_overlay_alignment": {
      "issue": "VOACAP overlays from open-hamclock-backend are 660x330 equirectangular (lat/lon grid). MapWidget's default view is azimuthal equidistant centered on DE. These projections do not align \u2014 you cannot simply blit the overlay PNG onto the map.",
      "solution_mvp": "Show the overlay in a separate flat-map panel (e.g., a secondary MapWidget or a dedicated OverlayPanel with equirectangular rendering). The original HamClock also had two map modes \u2014 'map A' (azimuthal) and 'map B' (flat). Implement a similar switch.",
      "solution_full": "Re-project the 660x330 pixel grid: for each screen pixel in MapWidget, compute its lat/lon via screenToLatLon(), look up the corresponding pixel in the equirectangular overlay, and blend. This is O(screen_w * screen_h) per frame but can be done once when the overlay updates (every 30 min).",
      "wasm_note": "In WASM mode, the KC2G MUF-RT PNG is fetched via the CORS proxy (/proxy/https://prop.kc2g.com/renders/current/mufd-normal-now.png). Ensure serve.py or the nginx cors-proxy.conf proxies that URL pattern.",
      "date_added": "2026-02-18"
    }
  },
  "api_examples": {
    "description": "Working curl commands for every WebServer endpoint. Base URL is http://localhost:8080 by default (configurable port).",
    "categories": {
      "core": {
        "description": "Core application endpoints",
        "endpoints": [
          {
            "endpoint": "/",
            "method": "GET",
            "description": "Live web interface with auto-refreshing screenshot and keyboard/mouse input",
            "curl": "curl http://localhost:8080/",
            "notes": "Opens in browser. Uses /live.jpg for display and /set_touch for click injection. Refresh rate defaults to 500ms (2 FPS)."
          },
          {
            "endpoint": "/live.jpg",
            "method": "GET",
            "description": "Current screenshot as JPEG (for automation, monitoring, or remote display)",
            "curl": "curl http://localhost:8080/live.jpg --output screenshot.jpg",
            "notes": "Updated every 250ms when requested. Quality=70. Used by the web UI for live updates."
          },
          {
            "endpoint": "/screen",
            "method": "GET",
            "description": "Screen power management (blank/unblank) and sleep prevention settings",
            "curl": "curl 'http://localhost:8080/screen?blank=1'\ncurl 'http://localhost:8080/screen?blank=0'\ncurl 'http://localhost:8080/screen?prevent=on'\ncurl 'http://localhost:8080/screen'",
            "notes": "?blank=1 powers off display (Linux: vcgencmd + xset dpms). ?prevent=on disables screen saver. No params returns JSON status."
          }
        ]
      },
      "input_injection": {
        "description": "Remote input control endpoints (keyboard and mouse simulation)",
        "endpoints": [
          {
            "endpoint": "/set_touch",
            "method": "GET",
            "description": "Inject mouse click at relative coordinates (0.0-1.0)",
            "curl": "curl 'http://localhost:8080/set_touch?rx=0.5&ry=0.5'",
            "notes": "rx/ry are relative coords (0.5, 0.5 = center). Simulates mouse down + up. Used by web UI."
          },
          {
            "endpoint": "/set_char",
            "method": "GET",
            "description": "Inject keyboard character or named key",
            "curl": "curl 'http://localhost:8080/set_char?k=A'\ncurl 'http://localhost:8080/set_char?k=Enter'\ncurl 'http://localhost:8080/set_char?k=Backspace'\ncurl 'http://localhost:8080/set_char?k=Escape'",
            "notes": "Supports printable chars and named keys: Enter, Backspace, Tab, Escape, ArrowLeft/Right/Up/Down, Delete, Home, End."
          }
        ]
      },
      "configuration": {
        "description": "Configuration query and update endpoints",
        "endpoints": [
          {
            "endpoint": "/get_config.txt",
            "method": "GET",
            "description": "Retrieve current configuration (callsign, grid, theme, lat/lon)",
            "curl": "curl http://localhost:8080/get_config.txt",
            "notes": "Returns plain text key-value pairs. Useful for scripts that need to read config."
          },
          {
            "endpoint": "/set_config",
            "method": "GET",
            "description": "Update configuration parameters",
            "curl": "curl 'http://localhost:8080/set_config?call=K4DRW&grid=EM75'\ncurl 'http://localhost:8080/set_config?theme=dark&lat=35.5&lon=-82.5'",
            "notes": "Params: call, grid, theme, lat, lon. Changes are saved to config.json immediately."
          },
          {
            "endpoint": "/get_de.txt",
            "method": "GET",
            "description": "Get DE (home) station info: callsign, grid, lat, lon",
            "curl": "curl http://localhost:8080/get_de.txt",
            "notes": "Returns DE_Callsign, DE_Grid, DE_Lat, DE_Lon in plain text."
          },
          {
            "endpoint": "/get_dx.txt",
            "method": "GET",
            "description": "Get DX station info: grid, lat, lon, distance (km), bearing (degrees)",
            "curl": "curl http://localhost:8080/get_dx.txt",
            "notes": "Returns DX_Grid, DX_Lat, DX_Lon, DX_Dist_km, DX_Bearing. If no DX set, returns 'DX not set'."
          },
          {
            "endpoint": "/set_mappos",
            "method": "GET",
            "description": "Programmatically set DE or DX position by lat/lon (returns computed grid square)",
            "curl": "curl 'http://localhost:8080/set_mappos?lat=35.5&lon=-82.5&target=de'\ncurl 'http://localhost:8080/set_mappos?lat=51.5&lon=-0.1&target=dx'",
            "notes": "Params: lat (float), lon (float), target (de|dx). Returns JSON with {target, lat, lon, grid}. Auto-calculates Maidenhead grid."
          },
          {
            "endpoint": "/get_time.txt",
            "method": "GET",
            "description": "Get current UTC time in ISO 8601 format",
            "curl": "curl http://localhost:8080/get_time.txt",
            "notes": "Returns 'Clock_UTC YYYY-MM-DDTHH:MM:SS Z'. Useful for time sync verification."
          }
        ]
      },
      "debug_api": {
        "description": "Debug and introspection endpoints (require ENABLE_DEBUG_API compile flag)",
        "endpoints": [
          {
            "endpoint": "/debug/widgets",
            "method": "GET",
            "description": "JSON dump of all registered widgets with bounds, actions, and debug data",
            "curl": "curl http://localhost:8080/debug/widgets | jq",
            "notes": "Returns {widgetName: {rect: [x,y,w,h], actions: [...], data: {...}}}. Essential for automated testing and debugging."
          },
          {
            "endpoint": "/debug/click",
            "method": "GET",
            "description": "Click a widget action by semantic name (automation-friendly alternative to pixel coordinates)",
            "curl": "curl 'http://localhost:8080/debug/click?widget=SetupScreen&action=save_button'",
            "notes": "Widget must implement getActions() and getActionRect(). Clicks the center of the action's rect. Returns 404 if widget/action not found."
          },
          {
            "endpoint": "/debug/type",
            "method": "GET",
            "description": "Type a full text string (alternative to multiple /set_char calls)",
            "curl": "curl 'http://localhost:8080/debug/type?text=Hello%20World'",
            "notes": "Injects SDL_TEXTINPUT events for each character. URL-encode spaces and special chars."
          },
          {
            "endpoint": "/debug/keypress",
            "method": "GET",
            "description": "Press a named key (enter, escape, tab, arrows, f11, etc.)",
            "curl": "curl 'http://localhost:8080/debug/keypress?key=enter'\ncurl 'http://localhost:8080/debug/keypress?key=f11'\ncurl 'http://localhost:8080/debug/keypress?key=escape'",
            "notes": "Supports: enter, tab, escape, backspace, delete, left, right, up, down, home, end, space, f11."
          },
          {
            "endpoint": "/debug/watchlist/add",
            "method": "GET",
            "description": "Add callsign to watchlist",
            "curl": "curl 'http://localhost:8080/debug/watchlist/add?call=W1AW'",
            "notes": "Adds callsign to WatchlistStore. Panel will highlight matching spots. Useful for automated testing."
          },
          {
            "endpoint": "/debug/store/set_solar",
            "method": "GET",
            "description": "Override solar data for testing (SFI, K-index, sunspot number)",
            "curl": "curl 'http://localhost:8080/debug/store/set_solar?sfi=150&k=5&sn=80'",
            "notes": "Injects test data into SolarDataStore. Params: sfi, k, sn. Useful for testing space weather displays without waiting for real data."
          },
          {
            "endpoint": "/debug/performance",
            "method": "GET",
            "description": "Performance metrics (FPS, uptime, port)",
            "curl": "curl http://localhost:8080/debug/performance | jq",
            "notes": "Returns JSON: {fps: N, port: N, running_since: seconds}. FPS is updated every frame."
          },
          {
            "endpoint": "/debug/health",
            "method": "GET",
            "description": "Health check for all data providers (ok status, last success timestamp, errors)",
            "curl": "curl http://localhost:8080/debug/health | jq",
            "notes": "Returns JSON: {ProviderName: {ok: bool, lastError: string, lastSuccess: ISO8601}}. Use for monitoring and alerting."
          },
          {
            "endpoint": "/debug/logs",
            "method": "GET",
            "description": "Log file location info",
            "curl": "curl http://localhost:8080/debug/logs | jq",
            "notes": "Returns info about log file path (~/.hamclock/hamclock.log) and stderr (journalctl). Not actual log contents."
          }
        ]
      }
    },
    "authentication_note": "SECURITY WARNING: All control endpoints (/set_*, /debug/*) are currently UNAUTHENTICATED. Do not expose WebServer to the public internet without a reverse proxy (nginx, Caddy) providing TLS + Basic Auth. For local development on localhost:8080, this is safe. For production, use Tailscale, VPN, or firewall rules to restrict access.",
    "cors_note": "CORS is not enabled. If you need to access the API from a web app on a different origin, add CORS headers in WebServer.cpp or use a reverse proxy to add them.",
    "propagation_overlay_api": {
      "description": "Propagation overlay endpoints added in 2026-02-18 for VOACAP parity. These are non-debug (always enabled) endpoints.",
      "endpoints": [
        {
          "endpoint": "/api/propagation/voacap",
          "method": "GET",
          "description": "VOACAP overlay schema and proxy URL. Returns request/response schema, colormap, and (if OHB_URL env is set) the proxied endpoint URL on open-hamclock-backend.",
          "params": "tx_lat, tx_lon, band (80m-6m), freq_mhz, hour_utc, year, month, path (0/1), mode (SSB/CW/FT8/WSPR/AM/RTTY), watts, overlay_type (muf/reliability/toa)",
          "curl": "curl 'http://localhost:8080/api/propagation/voacap?tx_lat=38.9&tx_lon=-77.0&band=20m&overlay_type=reliability' | jq",
          "notes": "When OHB_URL env var is set, returns overlay_endpoint pointing to open-hamclock-backend. Otherwise returns kc2g_muf_rt fallback info. Colormaps included in response for all overlay types."
        },
        {
          "endpoint": "/api/propagation/muf_rt",
          "method": "GET",
          "description": "KC2G real-time MUF map metadata. Returns image URL and CORS proxy URL. No backend needed.",
          "curl": "curl http://localhost:8080/api/propagation/muf_rt | jq",
          "notes": "Client fetches the returned image_url (or cors_proxy_url in WASM mode) to display the MUF-RT overlay. No computation required on the server."
        }
      ]
    }
  },
  "schema_version": "2.1"
}