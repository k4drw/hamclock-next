#include "PrefixManager.h"
#include <algorithm>
#include <cctype>
#include <string>

const PrefixManager::SmallPrefix PrefixManager::small_prefs[] = {
    {{'1', 'A', '\0', '\0'}, 4154, 1230},
    {{'1', 'S', '\0', '\0'}, 839, 11129},
    {{'3', 'A', '\0', '\0'}, 4345, 725},
    {{'3', 'B', '6', '\0'}, -1021, 5636},
    {{'3', 'B', '8', '\0'}, -2010, 5730},
    {{'3', 'B', '9', '\0'}, -1941, 6328},
    {{'3', 'C', '\0', '\0'}, 345, 847},
    {{'3', 'C', '0', '\0'}, 128, 540},
    {{'3', 'D', '2', '\0'}, -1807, 17825},
    {{'3', 'D', '2', 'C'}, -2144, 17438},
    {{'3', 'D', '2', 'X'}, -1248, 17701},
    {{'3', 'D', 'A', '\0'}, -2718, 3160},
    {{'3', 'V', '\0', '\0'}, 3647, 1011},
    {{'3', 'W', '\0', '\0'}, 1048, 10642},
    {{'3', 'X', '\0', '\0'}, 931, -1343},
    {{'3', 'Y', '\0', '\0'}, -5418, 322},
    {{'3', 'Y', '0', '\0'}, -6840, -9040},
    {{'4', 'J', '\0', '\0'}, 4036, 4989},
    {{'4', 'L', '\0', '\0'}, 4143, 4449},
    {{'4', 'O', '\0', '\0'}, 4244, 1926},
    {{'4', 'S', '\0', '\0'}, 656, 7951},
    {{'4', 'U', '1', 'I'}, 4612, 609},
    {{'4', 'U', '1', 'U'}, 4043, -7401},
    {{'4', 'W', '\0', '\0'}, -855, 12557},
    {{'4', 'X', '\0', '\0'}, 3146, 3514},
    {{'5', 'A', '\0', '\0'}, 3000, 1400},
    {{'5', 'B', '\0', '\0'}, 3510, 3322},
    {{'5', 'H', '\0', '\0'}, -400, 3300},
    {{'5', 'N', '\0', '\0'}, 627, 324},
    {{'5', 'R', '\0', '\0'}, -1700, 4600},
    {{'5', 'T', '\0', '\0'}, 2400, -800},
    {{'5', 'U', '\0', '\0'}, 1900, 1100},
    {{'5', 'V', '\0', '\0'}, 608, 112},
    {{'5', 'W', '\0', '\0'}, -1350, -17144},
    {{'5', 'X', '\0', '\0'}, 19, 3125},
    {{'5', 'Z', '\0', '\0'}, -117, 3649},
    {{'6', 'W', '\0', '\0'}, 1440, -1726},
    {{'6', 'Y', '\0', '\0'}, 1800, -7648},
    {{'7', 'O', '\0', '\0'}, 1500, 4700},
    {{'7', 'P', '\0', '\0'}, -2919, 2729},
    {{'7', 'Q', '\0', '\0'}, -1359, 3344},
    {{'7', 'X', '\0', '\0'}, 3400, 300},
    {{'8', 'P', '\0', '\0'}, 1306, -5937},
    {{'8', 'Q', '\0', '\0'}, 373, 7300},
    {{'8', 'R', '\0', '\0'}, 648, -5810},
    {{'9', 'A', '\0', '\0'}, 4548, 1558},
    {{'9', 'G', '\0', '\0'}, 533, -13},
    {{'9', 'H', '\0', '\0'}, 3554, 1431},
    {{'9', 'J', '\0', '\0'}, -1400, 2600},
    {{'9', 'K', '\0', '\0'}, 2920, 4759},
    {{'9', 'L', '\0', '\0'}, 830, -1315},
    {{'9', 'M', '2', '\0'}, 310, 10142},
    {{'9', 'M', '6', '\0'}, 601, 11607},
    {{'9', 'M', '8', '\0'}, 200, 11300},
    {{'9', 'N', '\0', '\0'}, 2743, 8519},
    {{'9', 'Q', '\0', '\0'}, 200, 2700},
    {{'9', 'U', '\0', '\0'}, -323, 2922},
    {{'9', 'V', '\0', '\0'}, 117, 10351},
    {{'9', 'X', '\0', '\0'}, -157, 3004},
    {{'9', 'Y', '\0', '\0'}, 1039, -6131},
    {{'A', '2', '\0', '\0'}, -2200, 2400},
    {{'A', '3', '\0', '\0'}, -2110, -17515},
    {{'A', '4', '\0', '\0'}, 2337, 5835},
    {{'A', '5', '\0', '\0'}, 2728, 8939},
    {{'A', '6', '\0', '\0'}, 2428, 5422},
    {{'A', '7', '\0', '\0'}, 2517, 5132},
    {{'A', '9', '\0', '\0'}, 2613, 5035},
    {{'A', 'P', '\0', '\0'}, 3100, 7100},
    {{'B', 'S', '7', '\0'}, 1518, 11776},
    {{'B', 'V', '\0', '\0'}, 2503, 12130},
    {{'B', 'Y', '1', '\0'}, 3954, 11625},
    {{'C', '2', '\0', '\0'}, -30, 16655},
    {{'C', '3', '\0', '\0'}, 4230, 131},
    {{'C', '5', '\0', '\0'}, 1328, -1639},
    {{'C', '6', '\0', '\0'}, 2505, -7720},
    {{'C', '9', '\0', '\0'}, -1400, 3800},
    {{'C', 'E', '0', '\0'}, -2706, -10921},
    {{'C', 'N', '\0', '\0'}, 3300, 500},
    {{'C', 'O', '\0', '\0'}, 2308, -8222},
    {{'C', 'P', '1', '\0'}, -1630, -6809},
    {{'C', 'T', '\0', '\0'}, 3844, -908},
    {{'C', 'U', '\0', '\0'}, 3739, -2534},
    {{'C', 'X', '\0', '\0'}, -3453, -5611},
    {{'C', 'Y', '0', '\0'}, 4402, -6000},
    {{'D', '2', '\0', '\0'}, -1200, 1700},
    {{'D', '4', '\0', '\0'}, 1500, -2351},
    {{'D', '6', '\0', '\0'}, -1141, 4316},
    {{'D', 'L', '\0', '\0'}, 5231, 1324},
    {{'D', 'U', '\0', '\0'}, 1435, 12100},
    {{'E', '3', '\0', '\0'}, 1520, 3900},
    {{'E', '4', '\0', '\0'}, 3177, 3521},
    {{'E', '5', '\0', '\0'}, -2123, -15977},
    {{'E', '6', '\0', '\0'}, -1857, -17006},
    {{'E', '7', '\0', '\0'}, 4352, 1825},
    {{'E', 'A', '\0', '\0'}, 4024, -341},
    {{'E', 'I', '\0', '\0'}, 5320, -615},
    {{'E', 'K', '\0', '\0'}, 4011, 4434},
    {{'E', 'L', '\0', '\0'}, 618, -1047},
    {{'E', 'P', '\0', '\0'}, 3500, 4800},
    {{'E', 'R', '\0', '\0'}, 4700, 2850},
    {{'E', 'S', '\0', '\0'}, 5922, 2448},
    {{'E', 'T', '\0', '\0'}, 1200, 3900},
    {{'E', 'U', '\0', '\0'}, 5354, 2734},
    {{'E', 'X', '\0', '\0'}, 4254, 7436},
    {{'E', 'Y', '\0', '\0'}, 3835, 6848},
    {{'E', 'Z', '\0', '\0'}, 3757, 5823},
    {{'F', '\0', '\0', '\0'}, 4852, 220},
    {{'G', '\0', '\0', '\0'}, 5130, 10},
    {{'H', '4', '\0', '\0'}, -926, 15957},
    {{'H', 'A', '\0', '\0'}, 4730, 1905},
    {{'H', 'B', '\0', '\0'}, 4657, 726},
    {{'H', 'C', '\0', '\0'}, -13, -7830},
    {{'H', 'H', '\0', '\0'}, 1832, -7220},
    {{'H', 'I', '\0', '\0'}, 1828, -6954},
    {{'H', 'K', '\0', '\0'}, 400, -7000},
    {{'H', 'L', '\0', '\0'}, 3733, 12658},
    {{'H', 'P', '\0', '\0'}, 858, -7931},
    {{'H', 'R', '\0', '\0'}, 1406, -8713},
    {{'H', 'S', '\0', '\0'}, 1800, 9900},
    {{'H', 'V', '\0', '\0'}, 4154, 1229},
    {{'H', 'Z', '\0', '\0'}, 2800, 4000},
    {{'I', '\0', '\0', '\0'}, 4154, 1229},
    {{'J', '2', '\0', '\0'}, 1136, 4309},
    {{'J', '3', '\0', '\0'}, 1203, -6145},
    {{'J', '5', '\0', '\0'}, 1151, -1535},
    {{'J', '6', '\0', '\0'}, 1401, -6100},
    {{'J', 'A', '\0', '\0'}, 3600, 13800},
    {{'K', '1', '\0', '\0'}, 4226, -7181},
    {{'K', '2', '\0', '\0'}, 4295, -7553},
    {{'K', '3', '\0', '\0'}, 4088, -7780},
    {{'K', '4', '\0', '\0'}, 3392, -8090},
    {{'K', '5', '\0', '\0'}, 3148, -9933},
    {{'K', '6', '\0', '\0'}, 3718, -11947},
    {{'K', '7', '\0', '\0'}, 4738, -12045},
    {{'K', '8', '\0', '\0'}, 4435, -8541},
    {{'K', '9', '\0', '\0'}, 4004, -8920},
    {{'K', '0', '\0', '\0'}, 3900, -10555},
    {{'L', 'A', '\0', '\0'}, 6100, 900},
    {{'L', 'U', '\0', '\0'}, -3400, -5600},
    {{'L', 'X', '\0', '\0'}, 4936, 609},
    {{'L', 'Y', '\0', '\0'}, 5440, 2519},
    {{'L', 'Z', '\0', '\0'}, 4241, 2319},
    {{'O', 'A', '\0', '\0'}, -1000, -7500},
    {{'O', 'D', '\0', '\0'}, 3353, 3529},
    {{'O', 'E', '\0', '\0'}, 4813, 1620},
    {{'O', 'H', '\0', '\0'}, 6300, 2400},
    {{'O', 'K', '\0', '\0'}, 5005, 1426},
    {{'O', 'M', '\0', '\0'}, 4809, 1709},
    {{'O', 'N', '\0', '\0'}, 5050, 420},
    {{'O', 'X', '\0', '\0'}, 7400, -4000},
    {{'O', 'Y', '\0', '\0'}, 6200, -642},
    {{'O', 'Z', '\0', '\0'}, 5540, 1235},
    {{'P', '2', '\0', '\0'}, -930, 14710},
    {{'P', '4', '\0', '\0'}, 1233, -7006},
    {{'P', '5', '\0', '\0'}, 3901, 12545},
    {{'P', 'A', '\0', '\0'}, 5220, 454},
    {{'P', 'Y', '\0', '\0'}, -1000, -5300},
    {{'P', 'Z', '\0', '\0'}, 552, -5514},
    {{'R', '1', '\0', '\0'}, 6000, 4000},
    {{'R', '2', '\0', '\0'}, 5443, 2030},
    {{'R', '3', '\0', '\0'}, 5545, 3735},
    {{'R', '4', '\0', '\0'}, 5134, 4602},
    {{'R', '6', '\0', '\0'}, 4502, 3900},
    {{'R', '9', '\0', '\0'}, 5510, 6124},
    {{'R', '0', '\0', '\0'}, 5601, 9250},
    {{'S', 'P', '\0', '\0'}, 5215, 2100},
    {{'S', 'V', '\0', '\0'}, 3759, 2343},
    {{'T', 'A', '\0', '\0'}, 3954, 3250},
    {{'T', 'F', '\0', '\0'}, 6409, -2151},
    {{'U', 'A', '\0', '\0'}, 5500, 3700},
    {{'V', 'E', '\0', '\0'}, 5000, -9500},
    {{'V', 'K', '\0', '\0'}, -2500, 13500},
    {{'V', 'P', '\0', '\0'}, 4000, -7000},
    {{'V', 'U', '\0', '\0'}, 2100, 7800},
    {{'X', 'E', '\0', '\0'}, 2300, -10300},
    {{'Y', 'B', '\0', '\0'}, -500, 11000},
    {{'Y', 'L', '\0', '\0'}, 5700, 2400},
    {{'Y', 'O', '\0', '\0'}, 4426, 2606},
    {{'Y', 'U', '\0', '\0'}, 4455, 2030},
    {{'Y', 'V', '\0', '\0'}, 700, -6500},
    {{'Z', 'L', '\0', '\0'}, -4118, 17447},
    {{'Z', 'P', '\0', '\0'}, -2400, -5700},
    {{'Z', 'S', '\0', '\0'}, -2600, 2900},
};

static const int N_SMALLPREFS =
    sizeof(PrefixManager::small_prefs) / sizeof(PrefixManager::small_prefs[0]);

bool PrefixManager::findLocation(const std::string &call, LatLong &ll) {
  if (call.empty())
    return false;

  // Simple prefix matching: try 4, 3, 2, 1 characters
  std::string upperCall = call;
  for (auto &c : upperCall)
    c = std::toupper(static_cast<unsigned char>(c));

  for (int len = std::min(4, (int)upperCall.length()); len > 0; --len) {
    std::string pref = upperCall.substr(0, len);
    for (int i = 0; i < N_SMALLPREFS; ++i) {
      bool match = true;
      for (int k = 0; k < 4; ++k) {
        if (small_prefs[i].pref[k] == '\0') {
          if (k >= len)
            break; // prefix in table is shorter and matched so far
          match = false;
          break; // table prefix ended but we wanted more
        }
        if (k >= len || small_prefs[i].pref[k] != pref[k]) {
          match = false;
          break;
        }
      }
      if (match) {
        ll.lat = small_prefs[i].lat * 0.01;
        ll.lon = small_prefs[i].lon * 0.01;
        return true;
      }
    }
  }

  return false;
}
